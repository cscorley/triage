<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Sun May 17 05:00:23 UTC 2015

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/PIG-3114/PIG-3114.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[PIG-3114] Duplicated macro name error when using pigunit</title>
                <link>https://issues.apache.org/jira/browse/PIG-3114</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;I&apos;m using PigUnit to test a pig script within which a macro is defined.&lt;br/&gt;
Pig runs fine on cluster but getting parsing error with pigunit.&lt;br/&gt;
So I tried very basic pig script with macro and getting similar error.&lt;/p&gt;

&lt;p&gt;org.apache.pig.impl.logicalLayer.FrontendException: ERROR 1000: Error during parsing. &amp;lt;line 9&amp;gt; null. Reason: Duplicated macro name &apos;my_macro_1&apos;&lt;br/&gt;
	at org.apache.pig.PigServer$Graph.parseQuery(PigServer.java:1607)&lt;br/&gt;
	at org.apache.pig.PigServer$Graph.registerQuery(PigServer.java:1546)&lt;br/&gt;
	at org.apache.pig.PigServer.registerQuery(PigServer.java:516)&lt;br/&gt;
	at org.apache.pig.tools.grunt.GruntParser.processPig(GruntParser.java:988)&lt;br/&gt;
	at org.apache.pig.pigunit.pig.GruntParser.processPig(GruntParser.java:61)&lt;br/&gt;
	at org.apache.pig.tools.pigscript.parser.PigScriptParser.parse(PigScriptParser.java:412)&lt;br/&gt;
	at org.apache.pig.tools.grunt.GruntParser.parseStopOnError(GruntParser.java:194)&lt;br/&gt;
	at org.apache.pig.pigunit.pig.PigServer.registerScript(PigServer.java:56)&lt;br/&gt;
	at org.apache.pig.pigunit.PigTest.registerScript(PigTest.java:160)&lt;br/&gt;
	at org.apache.pig.pigunit.PigTest.assertOutput(PigTest.java:231)&lt;br/&gt;
	at org.apache.pig.pigunit.PigTest.assertOutput(PigTest.java:261)&lt;br/&gt;
	at FirstPigTest.MyPigTest.testTop2Queries(MyPigTest.java:32)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at junit.framework.TestCase.runTest(TestCase.java:176)&lt;br/&gt;
	at junit.framework.TestCase.runBare(TestCase.java:141)&lt;br/&gt;
	at junit.framework.TestResult$1.protect(TestResult.java:122)&lt;br/&gt;
	at junit.framework.TestResult.runProtected(TestResult.java:142)&lt;br/&gt;
	at junit.framework.TestResult.run(TestResult.java:125)&lt;br/&gt;
	at junit.framework.TestCase.run(TestCase.java:129)&lt;br/&gt;
	at junit.framework.TestSuite.runTest(TestSuite.java:255)&lt;br/&gt;
	at junit.framework.TestSuite.run(TestSuite.java:250)&lt;br/&gt;
	at org.junit.internal.runners.JUnit38ClassRunner.run(JUnit38ClassRunner.java:84)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestReference.java:50)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:467)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:683)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:390)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:197)&lt;br/&gt;
Caused by: Failed to parse: &amp;lt;line 9&amp;gt; null. Reason: Duplicated macro name &apos;my_macro_1&apos;&lt;br/&gt;
	at org.apache.pig.parser.QueryParserDriver.makeMacroDef(QueryParserDriver.java:406)&lt;br/&gt;
	at org.apache.pig.parser.QueryParserDriver.expandMacro(QueryParserDriver.java:277)&lt;br/&gt;
	at org.apache.pig.parser.QueryParserDriver.parse(QueryParserDriver.java:178)&lt;br/&gt;
	at org.apache.pig.PigServer$Graph.parseQuery(PigServer.java:1599)&lt;br/&gt;
	... 30 more&lt;/p&gt;


&lt;p&gt;Pig script which is failing :&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;test.pig&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
DEFINE my_macro_1 (QUERY, A) RETURNS C {
    $C = ORDER $QUERY BY total DESC, $A;
} ;

data =  LOAD &apos;input&apos; AS (query:CHARARRAY);

queries_group = GROUP data BY query;

queries_count = FOREACH queries_group GENERATE group AS query, COUNT(data) AS total;

queries_ordered = my_macro_1(queries_count, query);

queries_limit = LIMIT queries_ordered 2;

STORE queries_limit INTO &apos;output&apos;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;If I remove macro pigunit works fine. Even just defining macro without using it results in parsing error.&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12625959">PIG-3114</key>
            <summary>Duplicated macro name error when using pigunit</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daijy">Daniel Dai</assignee>
                                    <reporter username="chetan.nadgire">Chetan Nadgire</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Jan 2013 01:49:42 +0000</created>
                <updated>Thu, 26 Feb 2015 06:31:09 +0000</updated>
                            <resolved>Fri, 27 Sep 2013 21:40:04 +0100</resolved>
                                    <version>0.11</version>
                                    <fixVersion>0.12.0</fixVersion>
                                    <component>parser</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>8</watches>
                                                                <comments>
                            <comment id="13547534" author="daijy" created="Wed, 9 Jan 2013 02:05:15 +0000"  >&lt;p&gt;Runs good for me with 0.10.1. Which version are you using?&lt;/p&gt;</comment>
                            <comment id="13547657" author="chetan.nadgire" created="Wed, 9 Jan 2013 05:32:52 +0000"  >&lt;p&gt;Hi Daniel,&lt;/p&gt;

&lt;p&gt;I am building pig.jar and pigunit.jar from branch-0.11. When I tried branch-0.10 getting different error:&lt;/p&gt;

&lt;p&gt;org.apache.pig.impl.logicalLayer.FrontendException: ERROR 1000: Error during parsing. null&lt;br/&gt;
	at org.apache.pig.PigServer$Graph.parseQuery(PigServer.java:1606)&lt;br/&gt;
	at org.apache.pig.PigServer$Graph.registerQuery(PigServer.java:1549)&lt;br/&gt;
	at org.apache.pig.PigServer.registerQuery(PigServer.java:549)&lt;br/&gt;
	at org.apache.pig.tools.grunt.GruntParser.processPig(GruntParser.java:968)&lt;br/&gt;
	at org.apache.pig.pigunit.pig.GruntParser.processPig(GruntParser.java:61)&lt;br/&gt;
	at org.apache.pig.tools.pigscript.parser.PigScriptParser.parse(PigScriptParser.java:386)&lt;br/&gt;
	at org.apache.pig.tools.grunt.GruntParser.parseStopOnError(GruntParser.java:190)&lt;br/&gt;
	at org.apache.pig.pigunit.pig.PigServer.registerScript(PigServer.java:53)&lt;br/&gt;
	at org.apache.pig.pigunit.PigTest.registerScript(PigTest.java:160)&lt;br/&gt;
	at org.apache.pig.pigunit.PigTest.assertOutput(PigTest.java:251)&lt;br/&gt;
	at FirstPigTest.MyPigTest.testTop2Queries(MyPigTest.java:32)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at junit.framework.TestCase.runTest(TestCase.java:168)&lt;br/&gt;
	at junit.framework.TestCase.runBare(TestCase.java:134)&lt;br/&gt;
	at junit.framework.TestResult$1.protect(TestResult.java:110)&lt;br/&gt;
	at junit.framework.TestResult.runProtected(TestResult.java:128)&lt;br/&gt;
	at junit.framework.TestResult.run(TestResult.java:113)&lt;br/&gt;
	at junit.framework.TestCase.run(TestCase.java:124)&lt;br/&gt;
	at junit.framework.TestSuite.runTest(TestSuite.java:232)&lt;br/&gt;
	at junit.framework.TestSuite.run(TestSuite.java:227)&lt;br/&gt;
	at org.junit.internal.runners.JUnit38ClassRunner.run(JUnit38ClassRunner.java:79)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestReference.java:50)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:467)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:683)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:390)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:197)&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
	at java.io.File.&amp;lt;init&amp;gt;(File.java:222)&lt;br/&gt;
	at org.apache.pig.parser.QueryParserUtils.getFileFromImportSearchPath(QueryParserUtils.java:205)&lt;br/&gt;
	at org.apache.pig.parser.QueryParserDriver.getMacroFile(QueryParserDriver.java:352)&lt;br/&gt;
	at org.apache.pig.parser.QueryParserDriver.makeMacroDef(QueryParserDriver.java:411)&lt;br/&gt;
	at org.apache.pig.parser.QueryParserDriver.expandMacro(QueryParserDriver.java:270)&lt;br/&gt;
	at org.apache.pig.parser.QueryParserDriver.parse(QueryParserDriver.java:171)&lt;br/&gt;
	at org.apache.pig.PigServer$Graph.parseQuery(PigServer.java:1598)&lt;br/&gt;
	... 29 more &lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Chetan&lt;/p&gt;</comment>
                            <comment id="13549127" author="daijy" created="Wed, 9 Jan 2013 22:35:55 +0000"  >&lt;p&gt;You are right. I can see it with pigunit. It runs fine with command line.&lt;/p&gt;</comment>
                            <comment id="13549272" author="chetan.nadgire" created="Thu, 10 Jan 2013 01:32:37 +0000"  >&lt;p&gt;Here&apos;s my investigation:&lt;/p&gt;

&lt;p&gt;I am using assertOutput(aliasInput, input, alias, expected) to verify output. &lt;/p&gt;

&lt;p&gt;1. &apos;PigTest::assertOutput(String aliasInput, String[] input, String alias, String[] expected)&apos; calls  &apos;PigTest::registerScript()&apos; to parse input query and to substitute aliases with input/output relations and load/store commands and generate query to be submitted to pigserver.&lt;/p&gt;

&lt;p&gt;It copies input (from pigtest) to destination file and calls &apos;PigTest::assertOutput(String alias, String[] expected)&apos;&lt;/p&gt;

&lt;p&gt;2. PigTest::assertOutput(String alias, String[] expected) again calls PigTest::registerScript() and submits generated query to pigserver again. Note that PigTest uses same instance on PigServer&lt;/p&gt;

&lt;p&gt;It then appends newline to expected output and calls &apos;assertEquals(StringUtils.join(expected, &quot;\n&quot;), StringUtils.join(getAlias(alias), &quot;\n&quot;));&apos;&lt;/p&gt;

&lt;p&gt;3. PigTest::getAlias() also calls registerScript()&lt;/p&gt;


&lt;p&gt;So PigServer::registerScript() it called 3 times with modification to same query. PigServer::Graph::scriptCache is used to store query and since same PigServer is used for three calls, same query gets appended in scriptCache.&lt;br/&gt;
When this query is parse it errors out due to multiple definitions of macro.&lt;/p&gt;

&lt;p&gt;Here&apos;s flow: &lt;/p&gt;

&lt;p&gt;PigTest::assertOutput(String aliasInput, String[] input, String alias, String[] expected)&lt;br/&gt;
 -&amp;gt; PigTest::registerScript()&lt;br/&gt;
    -&amp;gt;  PigServer::registerScript()&lt;/p&gt;

&lt;p&gt;query submitted to pigserver (scriptCache):&lt;/p&gt;


&lt;p&gt;DEFINE my_macro_1 (QUERY, A) RETURNS C &lt;/p&gt;
{
    $C = ORDER $QUERY BY total DESC, $A;
} &lt;br/&gt;
&lt;br/&gt;
data =  LOAD &apos;input&apos; AS (query:CHARARRAY);&lt;br/&gt;
queries_group = GROUP data BY query;&lt;br/&gt;
queries_count = FOREACH queries_group GENERATE group AS query, COUNT(data) AS total;&lt;br/&gt;
queries_ordered = my_macro_1(queries_count, query);&lt;br/&gt;
queries_limit = LIMIT queries_ordered 2;&lt;br/&gt;
STORE queries_limit INTO &apos;output&apos;;&lt;br/&gt;
&lt;br/&gt;
----------------------------------------------------------------------------------------&lt;br/&gt;
&lt;br/&gt;
PigTest::assertOutput(String alias, String[] expected)&lt;br/&gt;
 -&amp;gt; PigTest::registerScript()&lt;br/&gt;
    -&amp;gt;  PigServer::registerScript()&lt;br/&gt;
&lt;br/&gt;
query submitted to pigserver (scriptCache):&lt;br/&gt;
&lt;br/&gt;
DEFINE my_macro_1 (QUERY, A) RETURNS C {
    $C = ORDER $QUERY BY total DESC, $A;
}
&lt;p&gt; &lt;/p&gt;

&lt;p&gt;data =  LOAD &apos;input&apos; AS (query:CHARARRAY);&lt;br/&gt;
queries_group = GROUP data BY query;&lt;br/&gt;
queries_count = FOREACH queries_group GENERATE group AS query, COUNT(data) AS total;&lt;br/&gt;
queries_ordered = my_macro_1(queries_count, query);&lt;br/&gt;
queries_limit = LIMIT queries_ordered 2;&lt;br/&gt;
STORE queries_limit INTO &apos;output&apos;;&lt;br/&gt;
DEFINE my_macro_1 (QUERY, A) RETURNS C &lt;/p&gt;
{
    $C = ORDER $QUERY BY total DESC, $A;
} &lt;br/&gt;
&lt;br/&gt;
data =  LOAD &apos;input&apos; AS (query:CHARARRAY);&lt;br/&gt;
queries_group = GROUP data BY query;&lt;br/&gt;
queries_count = FOREACH queries_group GENERATE group AS query, COUNT(data) AS total;&lt;br/&gt;
queries_ordered = my_macro_1(queries_count, query);&lt;br/&gt;
queries_limit = LIMIT queries_ordered 2;&lt;br/&gt;
STORE queries_limit INTO &apos;output&apos;;&lt;br/&gt;
&lt;br/&gt;
----------------------------------------------------------------------------------------&lt;br/&gt;
&lt;br/&gt;
PigTest::assertEquals(String expected, String current)&lt;br/&gt;
 -&amp;gt; PigTest::registerScript()&lt;br/&gt;
    -&amp;gt;  PigServer::registerScript()&lt;br/&gt;
&lt;br/&gt;
query submitted to pigserver (scriptCache):&lt;br/&gt;
&lt;br/&gt;
DEFINE my_macro_1 (QUERY, A) RETURNS C {
    $C = ORDER $QUERY BY total DESC, $A;
}
&lt;p&gt; &lt;/p&gt;

&lt;p&gt;data =  LOAD &apos;input&apos; AS (query:CHARARRAY);&lt;br/&gt;
queries_group = GROUP data BY query;&lt;br/&gt;
queries_count = FOREACH queries_group GENERATE group AS query, COUNT(data) AS total;&lt;br/&gt;
queries_ordered = my_macro_1(queries_count, query);&lt;br/&gt;
queries_limit = LIMIT queries_ordered 2;&lt;br/&gt;
STORE queries_limit INTO &apos;output&apos;;&lt;br/&gt;
DEFINE my_macro_1 (QUERY, A) RETURNS C &lt;/p&gt;
{
    $C = ORDER $QUERY BY total DESC, $A;
} &lt;br/&gt;
&lt;br/&gt;
data =  LOAD &apos;input&apos; AS (query:CHARARRAY);&lt;br/&gt;
queries_group = GROUP data BY query;&lt;br/&gt;
queries_count = FOREACH queries_group GENERATE group AS query, COUNT(data) AS total;&lt;br/&gt;
queries_ordered = my_macro_1(queries_count, query);&lt;br/&gt;
queries_limit = LIMIT queries_ordered 2;&lt;br/&gt;
STORE queries_limit INTO &apos;output&apos;;&lt;br/&gt;
DEFINE my_macro_1 (QUERY, A) RETURNS C {
    $C = ORDER $QUERY BY total DESC, $A;
}
&lt;p&gt; &lt;/p&gt;

&lt;p&gt;data =  LOAD &apos;input&apos; AS (query:CHARARRAY);&lt;br/&gt;
queries_group = GROUP data BY query;&lt;br/&gt;
queries_count = FOREACH queries_group GENERATE group AS query, COUNT(data) AS total;&lt;br/&gt;
queries_ordered = my_macro_1(queries_count, query);&lt;br/&gt;
queries_limit = LIMIT queries_ordered 2;&lt;br/&gt;
STORE queries_limit INTO &apos;output&apos;;&lt;/p&gt;</comment>
                            <comment id="13549295" author="chetan.nadgire" created="Thu, 10 Jan 2013 02:11:45 +0000"  >&lt;p&gt;Added method in PigServer to clear scripCache.&lt;br/&gt;
Clearing cache before calling PigServer::registerScript() will fix macro redefinition error.&lt;/p&gt;</comment>
                            <comment id="13554399" author="chetan.nadgire" created="Tue, 15 Jan 2013 21:46:43 +0000"  >&lt;p&gt;PigServer::registerScript() it called multiple times by PigTest for same query. PigServer::Graph::scriptCache is used to store query and since same PigServer is used for all calls, same query gets appended in scriptCache.&lt;br/&gt;
When this query is parse it errors out due to multiple definitions of macro.&lt;br/&gt;
Clearing cache before calling PigServer::registerScript() will fix macro redefinition error.&lt;/p&gt;</comment>
                            <comment id="13560148" author="daijy" created="Tue, 22 Jan 2013 23:06:43 +0000"  >&lt;p&gt;Looks good. Would you mind add a unit test case?&lt;/p&gt;</comment>
                            <comment id="13581782" author="rohini" created="Wed, 20 Feb 2013 00:04:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chetan.nadgire&quot; class=&quot;user-hover&quot; rel=&quot;chetan.nadgire&quot;&gt;Chetan Nadgire&lt;/a&gt;,&lt;br/&gt;
   Is it not possible for you to use a different PigServer instance for each test case? Clearing the scriptCache in the registerScript() might break test cases of other users who register script multiple times with different scripts. ï¿½Also clearing just the current DAG might not work when there are nested scripts (Look for the graphs LinkedList in PigServer which stores multiple graphs)&lt;/p&gt;</comment>
                            <comment id="13582532" author="chetan.nadgire" created="Wed, 20 Feb 2013 21:26:36 +0000"  >&lt;p&gt;Taking a look. PigTest checks for existing instance of PigServer and reuses it instead of creating new instance, will debug more. &lt;br/&gt;
Also did not see any unit test failures after applying this patch.&lt;/p&gt;

&lt;p&gt;Right now pigunit build is failing on branch 0.11, opened &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3201&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/PIG-3201&lt;/a&gt; to track this issue.&lt;/p&gt;</comment>
                            <comment id="13583936" author="rohini" created="Fri, 22 Feb 2013 05:49:33 +0000"  >&lt;p&gt;Then we should probably look at adding a reInitialize method to PigTest which will reset the PigServer instance and can be used in tests like this. &lt;/p&gt;</comment>
                            <comment id="13635760" author="alangates" created="Thu, 18 Apr 2013 23:15:11 +0100"  >&lt;p&gt;Canceling patch pending agreement on how to address the issue.&lt;/p&gt;</comment>
                            <comment id="13690637" author="sajidraza" created="Fri, 21 Jun 2013 20:39:02 +0100"  >&lt;p&gt;I see the same behavior, and I would urge the maintainers to come to an agreement on the fix.&lt;/p&gt;</comment>
                            <comment id="13690641" author="sajidraza" created="Fri, 21 Jun 2013 20:44:27 +0100"  >&lt;p&gt;BTW, to get around the issues I created my own sub-class of PigTest with an overridden registerScript method that resets the PigServer instance on every invocation.&lt;/p&gt;

&lt;p&gt;Doing so is inefficient since I&apos;m reinitializing PigServer and registerScript is called a number of times.&lt;/p&gt;

&lt;p&gt;Why does PigTest register the text of the script multiple times with the PigServer?&lt;/p&gt;

&lt;p&gt;I would suggest lazily parsing the script when the user calls assertOutput. Registering the script once when the input alias has been specified would probably make life easier.&lt;/p&gt;

&lt;p&gt;Either way, it would be nice to have a component that a) does not rely on global (static) state, and b) that allows the end-user some transparency into how it manages resources.&lt;/p&gt;</comment>
                            <comment id="13718179" author="metaruslan" created="Wed, 24 Jul 2013 10:39:28 +0100"  >&lt;p&gt;Sajid Raza:&lt;br/&gt;
Can you please paste the code for your workaround?&lt;/p&gt;</comment>
                            <comment id="13719060" author="sajidraza" created="Thu, 25 Jul 2013 01:01:22 +0100"  >&lt;p&gt;Attached the workaround to this JIRA.&lt;/p&gt;</comment>
                            <comment id="13719061" author="sajidraza" created="Thu, 25 Jul 2013 01:01:47 +0100"  >&lt;p&gt;Temporary workaround in end-user code to get PigTest to work.&lt;/p&gt;</comment>
                            <comment id="13719934" author="metaruslan" created="Thu, 25 Jul 2013 20:24:50 +0100"  >&lt;p&gt;Sajid Raza:&lt;br/&gt;
Thanks a lot!&lt;/p&gt;</comment>
                            <comment id="13723539" author="metaruslan" created="Tue, 30 Jul 2013 09:06:07 +0100"  >&lt;p&gt;Sajid,&lt;/p&gt;

&lt;p&gt;The patch didn&apos;t work for me&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I am getting the same &quot;Reason: Duplicated macro name...&quot;&lt;br/&gt;
Also I see the message &quot;No matching static PigServer field found to patch.&quot; appearing in the console two times. My Pig version is&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;cloudera@localhost pig-scripts&amp;#93;&lt;/span&gt;$ pig -version&lt;br/&gt;
Apache Pig version 0.11.0-cdh4.3.0 (rexported) &lt;br/&gt;
compiled May 27 2013, 20:48:21&lt;/p&gt;

&lt;p&gt;Any thoughts? Any help would be much appreciated.&lt;/p&gt;

&lt;p&gt;I also noticed another problem with Macros:&lt;br/&gt;
Here org.apache.pig.pigunit.PigTest.PigTest(String[], String[], String)&lt;br/&gt;
the STORE and DUMP statements are erased as far as I understand, but if there is a STORE statement in my Macro, it doesn&apos;t get erased&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Should we open another jira for it?&lt;/p&gt;</comment>
                            <comment id="13742612" author="sajidraza" created="Fri, 16 Aug 2013 22:19:13 +0100"  >&lt;p&gt;Sorry, I haven&apos;t looked into the Cloudera&apos;s version of Pig. I&apos;d suggest poking through their source code snapshot.&lt;/p&gt;</comment>
                            <comment id="13779457" author="daijy" created="Fri, 27 Sep 2013 00:39:45 +0100"  >&lt;p&gt;The issue is script is accidentally registered twice in some cases. Attach a patch.&lt;/p&gt;</comment>
                            <comment id="13779470" author="rohini" created="Fri, 27 Sep 2013 01:06:03 +0100"  >&lt;p&gt;patch does not have top_queries_macro.pig. Looks good otherwise&lt;/p&gt;</comment>
                            <comment id="13779518" author="daijy" created="Fri, 27 Sep 2013 01:59:04 +0100"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;Rohini Palaniswamy&lt;/a&gt;, attached new patch include the missing file.&lt;/p&gt;</comment>
                            <comment id="13780216" author="rohini" created="Fri, 27 Sep 2013 19:33:37 +0100"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13780353" author="daijy" created="Fri, 27 Sep 2013 21:40:04 +0100"  >&lt;p&gt;Patch committed to both branch 0.12 and trunk.&lt;/p&gt;</comment>
                            <comment id="14335819" author="jserrano" created="Wed, 25 Feb 2015 01:46:50 +0000"  >&lt;p&gt;It looks like the issue is still present in version 0.12.0, 0.12.1, 0.13.0 and 0.14.0. The same script (test.pig) is failing with the exact same error. I&apos;m attaching the code I used to reproduce the error (bug_pig.tbz2).&lt;/p&gt;</comment>
                            <comment id="14335820" author="jserrano" created="Wed, 25 Feb 2015 01:48:02 +0000"  >&lt;p&gt;Maven project to reproduce the issue. &quot;mvn test&quot; to run the test.&lt;/p&gt;</comment>
                            <comment id="14337976" author="daijy" created="Thu, 26 Feb 2015 06:31:09 +0000"  >&lt;p&gt;The original fix does not apply to the new function introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2692&quot; title=&quot;Make the Pig unit faciliities more generalizable and update javadocs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2692&quot;&gt;&lt;del&gt;PIG-2692&lt;/del&gt;&lt;/a&gt;. I cannot find a easy fix for that. We do need to register the query multiple times to get alias mock working, but that causes &quot;Duplicated macro&quot; error.&lt;/p&gt;

&lt;p&gt;One simple work around is to change the test to register macro separately:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] script = {
                &lt;span class=&quot;code-quote&quot;&gt;&quot;data =  LOAD &apos;input&apos; AS (query:CHARARRAY);&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;queries_group = GROUP data BY query;&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;queries_count = FOREACH queries_group GENERATE group AS query, COUNT(data) AS total;&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;queries_ordered = my_macro_1(queries_count, query);&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;queries_limit = LIMIT queries_ordered 2;&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;STORE queries_limit INTO &apos;output&apos;;&quot;&lt;/span&gt;
        };
        PigTest test = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PigTest(script, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[]{});
        test.getPigServer().registerQuery(&lt;span class=&quot;code-quote&quot;&gt;&quot;DEFINE my_macro_1 (QUERY, A) RETURNS C {&quot;&lt;/span&gt; +
                &lt;span class=&quot;code-quote&quot;&gt;&quot;$C = ORDER $QUERY BY total DESC, $A;&quot;&lt;/span&gt; +
                &lt;span class=&quot;code-quote&quot;&gt;&quot;} ;&quot;&lt;/span&gt;);
        test.assertOutput(&lt;span class=&quot;code-quote&quot;&gt;&quot;data&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] {&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;},
                &lt;span class=&quot;code-quote&quot;&gt;&quot;queries_limit&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] {&lt;span class=&quot;code-quote&quot;&gt;&quot;(1)&quot;&lt;/span&gt;});
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12522792">PIG-2279</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12605354" name="PIG-3114-2.patch" size="3897" author="daijy" created="Fri, 27 Sep 2013 00:39:45 +0100"/>
                            <attachment id="12605370" name="PIG-3114-3.patch" size="5642" author="daijy" created="Fri, 27 Sep 2013 01:59:04 +0100"/>
                            <attachment id="12564092" name="PIG-3114.patch" size="2159" author="chetan.nadgire" created="Thu, 10 Jan 2013 02:23:12 +0000"/>
                            <attachment id="12564090" name="PIG-3114.patch" size="2159" author="chetan.nadgire" created="Thu, 10 Jan 2013 02:11:45 +0000"/>
                            <attachment id="12594068" name="PatchedPigTest.java" size="3180" author="sajidraza" created="Thu, 25 Jul 2013 01:01:47 +0100"/>
                            <attachment id="12700643" name="bug_pig.tbz2" size="1178" author="jserrano" created="Wed, 25 Feb 2015 01:48:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Wed, 9 Jan 2013 02:05:15 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>302541</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2|hz0yfz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>249590</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Clearing cache before calling PigServer::registerScript() to fix macro redefinition error.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                        <customfieldname>Time in Status</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>